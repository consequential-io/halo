{
  "id": "HALO-61",
  "title": "Implement run_rca tool (Deep RCA)",
  "type": "task",
  "status": "closed",
  "priority": 0,
  "description": "Implement deep root cause analysis tool.\n\n## SME Input\n\"It's spend RCA or CPA std deviation.\"\n\n## Tool Signature\n```python\nasync def run_rca(\n    anomaly_ad: dict,\n    all_ads: List[dict],\n    anomaly_metric: str,\n    config: dict = RCA_CONFIG\n) -> dict\n```\n\n## Analysis Dimensions (Deep)\n1. **Audience Analysis**\n   - audience_engagement_score vs platform avg\n   - competitive_pressure vs platform avg\n\n2. **Creative Analysis**\n   - creative_variants count\n   - unique_creatives count\n   - creative_status (fatigued?)\n   - recency (days since created)\n\n3. **Budget Analysis**\n   - budget_utilization\n   - daily_spend_velocity\n   - avg_daily_budget vs actual\n\n4. **Comparison to Similar Ads**\n   - Same ad_provider\n   - Same store\n   - Same ad_type\n\n## Implementation\n```python\ndef run_rca(anomaly_ad, all_ads, anomaly_metric):\n    root_causes = []\n    \n    # 1. Audience Analysis\n    ad_engagement = anomaly_ad.get('audience_engagement_score', 0)\n    platform_engagement = sum(ad.get('audience_engagement_score', 0) for ad in all_ads) / len(all_ads)\n    if ad_engagement < platform_engagement * 0.5:\n        root_causes.append({\n            \"factor\": \"audience_engagement\",\n            \"finding\": f\"Engagement score {ad_engagement:.1f} vs platform avg {platform_engagement:.1f}\",\n            \"impact\": \"high\",\n            \"suggestion\": \"Review audience targeting\"\n        })\n    \n    # 2. Creative Analysis\n    if anomaly_ad.get('creative_variants', 1) == 1:\n        root_causes.append({\n            \"factor\": \"creative_variants\",\n            \"finding\": \"Single creative variant (no A/B testing)\",\n            \"impact\": \"medium\",\n            \"suggestion\": \"Test 2-3 creative variants\"\n        })\n    \n    if anomaly_ad.get('creative_status') == 'fatigued':\n        root_causes.append({\n            \"factor\": \"creative_fatigue\",\n            \"finding\": f\"Creative running for {anomaly_ad.get('recency', 0)} days\",\n            \"impact\": \"high\",\n            \"suggestion\": \"Refresh creative assets\"\n        })\n    \n    # 3. Competitive Pressure\n    ad_pressure = anomaly_ad.get('competitive_pressure', 0)\n    if ad_pressure > 0.7:\n        root_causes.append({\n            \"factor\": \"competitive_pressure\",\n            \"finding\": f\"High competitive pressure: {ad_pressure:.2f}\",\n            \"impact\": \"medium\",\n            \"suggestion\": \"Consider different placements or dayparting\"\n        })\n    \n    # 4. Comparison to similar ads\n    same_provider = [ad for ad in all_ads if ad.get('ad_provider') == anomaly_ad.get('ad_provider')]\n    same_store = [ad for ad in all_ads if ad.get('store') == anomaly_ad.get('store')]\n    same_type = [ad for ad in all_ads if ad.get('ad_type') == anomaly_ad.get('ad_type')]\n    \n    comparison = {\n        f\"same_provider_avg_{anomaly_metric.lower()}\": round(sum(ad.get(anomaly_metric, 0) for ad in same_provider) / len(same_provider), 2) if same_provider else 0,\n        f\"same_store_avg_{anomaly_metric.lower()}\": round(sum(ad.get(anomaly_metric, 0) for ad in same_store) / len(same_store), 2) if same_store else 0,\n        f\"same_type_avg_{anomaly_metric.lower()}\": round(sum(ad.get(anomaly_metric, 0) for ad in same_type) / len(same_type), 2) if same_type else 0,\n    }\n    \n    # Generate recommendations\n    recommendations = [rc[\"suggestion\"] for rc in root_causes]\n    if not recommendations:\n        recommendations = [\"Anomaly detected but no clear root cause identified. Manual review recommended.\"]\n    \n    return {\n        \"anomaly_summary\": {\n            \"ad_name\": anomaly_ad.get('ad_name'),\n            \"metric\": anomaly_metric,\n            \"value\": anomaly_ad.get(anomaly_metric),\n            \"z_score\": anomaly_ad.get(f'z_{anomaly_metric.lower()}', 'N/A')\n        },\n        \"root_causes\": root_causes,\n        \"comparison_to_similar\": comparison,\n        \"recommended_actions\": recommendations\n    }\n```",
  "labels": [
    "tool",
    "rca",
    "ai-first",
    "critical-path"
  ],
  "created": "2026-01-31T15:30:00Z",
  "updated": "2026-01-31T16:00:00Z",
  "parent": "HALO-4",
  "blockedBy": [
    "HALO-59",
    "HALO-60"
  ]
}
