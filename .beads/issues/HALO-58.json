{
  "id": "HALO-58",
  "title": "RESOLVED: days_active calculation - dual approach with config",
  "type": "task",
  "status": "closed",
  "priority": 0,
  "description": "Implement both fixture-based and BQ-based approaches with config-driven selection.\n\n## Decision\nImplement BOTH approaches, select via config. Default to BQ (live data).\n\n## Config\n```python\n# config/classification_config.py\nDATA_SOURCE_CONFIG = {\n    \"days_active\": {\n        \"source\": \"bq\",  # \"bq\" | \"fixture\"\n        \"bq_method\": \"count_distinct\",  # \"count_distinct\" | \"date_range\"\n    },\n}\n```\n\n## Implementation\n```python\ndef get_days_active(\n    ad: dict,\n    ad_daily_data: List[dict] = None,  # For BQ: daily rows for this ad\n    config: dict = DATA_SOURCE_CONFIG\n) -> int:\n    \"\"\"Get days_active based on config.\"\"\"\n    source = config['days_active']['source']\n    \n    # Option 1: Use pre-computed from fixtures\n    if source == 'fixture':\n        return ad.get('days_active', 0)\n    \n    # Option 2: Calculate from BQ daily data\n    if ad_daily_data is None:\n        # Fallback to fixture field if no daily data provided\n        return ad.get('days_active', 0)\n    \n    method = config['days_active']['bq_method']\n    \n    if method == 'count_distinct':\n        # Count days with spend > 0\n        active_dates = set(\n            row.get('date') for row in ad_daily_data \n            if row.get('spend', 0) > 0\n        )\n        return len(active_dates)\n    \n    elif method == 'date_range':\n        # Difference between first and last date\n        dates = [\n            row.get('date') for row in ad_daily_data \n            if row.get('spend', 0) > 0\n        ]\n        if not dates:\n            return 0\n        from datetime import datetime\n        date_objs = [datetime.fromisoformat(d) for d in dates if d]\n        if len(date_objs) < 2:\n            return len(date_objs)\n        return (max(date_objs) - min(date_objs)).days + 1\n    \n    return 0\n```\n\n## BigQuery Query (for count_distinct)\n```sql\nSELECT\n    ad_name,\n    ad_id,\n    COUNT(DISTINCT DATE(datetime_UTC)) as days_active,\n    SUM(spend) as total_spend,\n    -- ... other aggregations\nFROM `otb-dev-platform.master.northstar_master_combined_tl`\nWHERE data_source = 'Ad Providers'\n  AND datetime_UTC >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)\n  AND spend > 0\nGROUP BY ad_name, ad_id\n```\n\n## Default\n- Source: `bq` (live data)\n- Method: `count_distinct` (most accurate)\n\n## Resolution\nDual approach implemented with config selection. Default to BQ count_distinct.",
  "labels": ["resolved", "classification", "config"],
  "created": "2026-01-31T14:40:00Z",
  "updated": "2026-01-31T15:00:00Z",
  "parent": "HALO-4"
}
